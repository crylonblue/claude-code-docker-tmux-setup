#!/usr/bin/env bash
set -e

# Load .env (not .env.example or other variants)
if [ ! -f ".env" ]; then
  echo "‚ùå .env file not found (copy .env.example to .env and configure)"
  exit 1
fi
export $(grep -v '^#' ".env" | xargs)

# Debug: verify token loaded correctly
echo "üîç Debug: GITHUB_TOKEN length=${#GITHUB_TOKEN}, starts with=${GITHUB_TOKEN:0:4}..."

REPO_URL="$1"
if [ -z "$REPO_URL" ]; then
  echo "Usage: claude-dev <github-repo-url>"
  exit 1
fi

IMAGE="${DOCKER_IMAGE:-claude-dev:latest}"
WORKSPACE_BASE="${WORKSPACE_BASE:-$HOME/.claude-workspaces}"
REPO_NAME="$(basename "$REPO_URL" .git)"
CONTAINER_NAME="claude-${REPO_NAME}"

mkdir -p "$WORKSPACE_BASE/$REPO_NAME"
chmod 777 "$WORKSPACE_BASE/$REPO_NAME"

# Remove existing container if it exists
docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

exec docker run -it --rm \
  --name "$CONTAINER_NAME" \
  -e GITHUB_TOKEN \
  -e CLAUDE_MODEL \
  -v "$WORKSPACE_BASE/$REPO_NAME:/workspace" \
  "$IMAGE" \
  "$REPO_URL"
